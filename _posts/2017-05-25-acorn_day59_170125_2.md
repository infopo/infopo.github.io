---
layout: post
title: Flume - 17/01/25 (2)
category: acorn수업
---

$ wget http://apache.mirror.cdnetworks.com/flume/1.7.0/apache-flume-1.7.0-bin.tar.gz
$ tar -vxzf apache-flume-1.7.0-bin.tar.gz
$ ln -s apache-flume-1.7.0-bin flume
$ vi ~/.bashrc
export FLUME_HOME=/home/hadoop/flume
export FLUME_CONF_DIR=/home/hadoop/flume/conf
export PATH=$PATH:$FLUME_HOME/bin

$ source ~/.bashrc
$ cd flume
$ cd conf
$ vi agent1.conf
agent1.sources = netsource
agent1.sinks = logsink
agent1.channels = memorychannel

agent1.sources.netsource.type = netcat
agent1.sources.netsource.bind = localhost
agent1.sources.netsource.port = 3000

agent1.sinks.logsink.type = logger

agent1.channels.memorychannel.type = memory
agent1.channels.memorychannel.capacity = 1000
agent1.channels.memorychannel.transactionCapacity = 100

agent1.sources.netsource.channels = memorychannel
agent1.sinks.logsink.channel = memorychannel

$ flume-ng agent --conf conf --conf-file $FLUME_HOME/conf/agent1.conf --name agent1
17/01/25 14:52:33 INFO node.Application: Starting Channel memorychannel
17/01/25 14:52:33 INFO instrumentation.MonitoredCounterGroup: Monitored counter group for type: CHANNEL, name: memorychannel: Successfully registered new MBean.
17/01/25 14:52:33 INFO instrumentation.MonitoredCounterGroup: Component type: CHANNEL, name: memorychannel started
17/01/25 14:52:33 INFO node.Application: Starting Sink logsink
17/01/25 14:52:33 INFO node.Application: Starting Source netsource
17/01/25 14:52:33 INFO source.NetcatSource: Source starting
17/01/25 14:52:33 INFO source.NetcatSource: Created serverSocket:sun.nio.ch.ServerSocketChannelImpl[/127.0.0.1:3000]
#여기까지 나오면 정상
INFO sink.LoggerSink: Event: { headers:{} body: 68 65 6C 6C 6F hello }
INFO sink.LoggerSink: Event: { headers:{} body: 6F 72 69 65 6E 74 65 64 oriented }
INFO sink.LoggerSink: Event: { headers:{} body: 31 32 33 123 }

#다른 터미널을 하나 열어서

$ curl telnet://localhost:3000
#이제 prompt명령을 치면 된다.
hello
OK
oriented
OK
123
OK

source(내가 입력한 것) - channel(FLUME) - sink(목적지, 입력한 데이터 출력)

$ vi agent2.conf
agent2.sources = exesource
agent2.sinks = filesink
agent2.channels = filechannel

agent2.sources.exesource.type = exec
agent2.sources.exesource.command = cat /home/hadoop/flume/message

agent2.sinks.filesink.type = FILE_ROLL
agent2.sinks.filesink.sink.directory = /home/hadoop/flume/files
agent2.sinks.filesink.sink.rollInterval = 10

agent2.channels.filechannel.type = file
agent2.channels.filechannel.checkpointDir = /home/hadoop/flume/checkpoint
agent2.channels.filechannel.dataDirs = /home/hadoop/flume/fc/data

agent2.sources.exesource.channels = filechannel
agent2.sinks.filesink.channel = filechannel

$ cd flume
$ vi message
아무값이나 입력하면 됨
$ mkdir files
#아래에 flume-ng를 실행하고 files/를 확인하면 파일들이 생기는데asdfasdf

$ flume-ng agent --conf conf --conf-file $FLUME_HOME/conf/agent2.conf --name agent2

$ vi agent4.conf
agent4.sources = netsource
agent4.sinks = hdfssink
agent4.channels = memorychannel

agent4.sources.netsource.type = netcat
agent4.sources.netsource.bind = localhost
agent4.sources.netsource.port = 3000

agent4.sinks.hdfssink.type = hdfs
agent4.sinks.hdfssink.hdfs.path = /flume
agent4.sinks.hdfssink.hdfs.filePrefix = log
agent4.sinks.hdfssink.hdfs.rollInterval = 0
agent4.sinks.hdfssink.hdfs.rollCount = 3
agent4.sinks.hdfssink.hdfs.fileType = DataStream

agent4.channels.memorychannel.type = memory
agent4.channels.memorychannel.capacity = 1000
agent4.channels.memorychannel.transactionCapacity = 100

agent4.sources.netsource.channels = memorychannel
agent4.sinks.hdfssink.channel = memorychannel

$ flume-ng agent --conf conf --conf-file $FLUME_HOME/conf/agent4.conf --name agent4
17/01/25 15:22:50 INFO hdfs.BucketWriter: Creating /flume/log.1485325370444.tmp
17/01/25 15:22:57 WARN hdfs.BucketWriter: Block Under-replication detected. Rotating file.
17/01/25 15:22:57 INFO hdfs.BucketWriter: Closing /flume/log.1485325370444.tmp
17/01/25 15:22:57 INFO hdfs.BucketWriter: Renaming /flume/log.1485325370444.tmp to /flume/log.1485325370444

# 다른 터미널에서
$ curl telnet://localhost:3000
아무 값이나 입력하면 hdfs에 입력 된다.

# 또 다른 터미널에서
$ hdfs dfs -cat /flume/log.1484325370444
