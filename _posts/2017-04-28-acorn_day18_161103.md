---
layout: post
title: 오라클SQL - 16/11/03
category: acorn수업
---

## Cursor

- 암시적 커서: 선택된 레코드(행)이 1개 일 때
- 명시적 커서: 선택된 레코드(행)이 1개 이상일 때
- select문에서 이루어지는 것들
- for aa in (select empno, ename from emp)

```
set serveroutput on

create or replace procedure hiredate_info
  (p_year in char := 0)
is
  inemp emp%rowtype;
  cursor emp_cursor is
    select empno, ename, sal from emp where to_char(hiredate,'yyyy') = p_year;

begin
  open emp_cursor;
    loop
      fetch emp_cursor into inemp.empno, inemp.ename, inemp.sal;
      exit when emp_cursor%notfound;
      dbms_output.put_line(inemp.empno || ' ' || inemp.ename || ' '|| inemp.sal);
    end loop;
  close emp_cursor;
end hiredate_info;

--show errors;
execute hiredate_info(1980);
```

```
declare
  v_empno emp.empno%type;
  v_ename emp.ename%type;
  cursor c1 is select empno, ename from emp;
begin
  open c1;
    loop
      fetch c1 into v_empno, v_ename;
      exit when c1%notfound or c1%notfound is null;
      dbms_output.put_line(v_empno||' '|| v_ename);
    end loop;
  close c1;
end;

set serveroutput on;
--cursor는 한 번 실행되고 없어진다.

--exit when c1%notfound; --> row가 한건도 없다면 exit
--exit when c1%rowcount > 10; --> row count가 10보다 크면 exit
```

### for loop를 이용한 cursor

```
declare
  cursor empcur is select empno, ename, sal from emp;
begin
  for r in empcur loop
    dbms_output.put_line(r.empno||'-'||r.ename);
  end loop;
end;
--바로 위의 예제와 동일한데, fetch를 안쓰고 있다
```

### cursor를 이용한 RETURN 사례(11/01화, for문을 이용한 암묵적 cursor)

```
set serveroutput on;
show errors;
```

```
create or replace procedure getempcursor(
  s_empno in emp.empno%type,
  c_emp out sys_refcursor)
is
  begin open c_emp for
  select * from emp /*where empno = s_empno*/; -- 주석처리한 부분을 두면 모든 정보 출력됨
end;
--cursor close를 하면 안됨
```
```
declare
  c_emp sys_refcursor;
  emp_all emp%rowtype;
begin
  getempcursor(7788,c_emp);
  loop
    fetch c_emp into emp_all; --emp_all의 행 하나를 통째로 가져옴
    exit when c_emp%notfound;
    dbms_output.put_line(emp_all.ename||''||emp_all.empno);
  end loop;
  close c_emp; --이 부분을 지워도 실행은 됨
end;
```
